-- ESP Script with all features: Rainbow ESP Box/Tracers, BillboardGui Stud Distance, Fullbright Prompt, X-Ray, and Freecam.

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local Lighting = game:GetService("Lighting")

-- Added a small wait to ensure LocalPlayer and PlayerGui are ready before execution
wait(0.5) 

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local ESPEnabled = false
local ESPFolder = Instance.new("Folder")
ESPFolder.Name = "RainbowESP"
ESPFolder.Parent = game.CoreGui

local freecamEnabled = false
local xrayEnabled = false
local originalTransparencies = {}
local originalLightingColorShift = Lighting.ColorShift_Bottom

-- Rainbow color generator
local function getRainbowColor()
	local time = tick() * 5
	local r = math.sin(time) * 0.5 + 0.5
	local g = math.sin(time + 2) * 0.5 + 0.5
	local b = math.sin(time + 4) * 0.5 + 0.5
	return Color3.new(r, g, b)
end

-- Create ESP elements for a player
local function createESP(player)
    local character = player.Character
    if not character then return end
    
    -- Guaranteed access to the RootPart
    local rootPart = character:WaitForChild("HumanoidRootPart", 5)
	local humanoid = character:FindFirstChildOfClass("Humanoid")
	if not rootPart or not humanoid then return end

	-- Create BoxHandleAdornment (The Box)
	local box = Instance.new("BoxHandleAdornment")
	box.Adornee = rootPart 
	box.AlwaysOnTop = true
	box.ZIndex = 10
	box.Transparency = 0.5
	box.Size = Vector3.new(3, humanoid.HipHeight * 2 + 1, 1) -- Use character height for size
	box.Color3 = Color3.new(1, 1, 1) 
	box.Parent = ESPFolder
	box.Visible = true 

	-- Create BillboardGui for Distance Text (FIXED METHOD)
	local billboardGui = Instance.new("BillboardGui")
	billboardGui.Name = "DistanceBillboard"
	billboardGui.AlwaysOnTop = true
	billboardGui.Size = UDim2.new(0, 100, 0, 20) -- Fixed screen size
	billboardGui.StudsOffset = Vector3.new(0, humanoid.HipHeight * 2 + 1, 0) -- Position above the character
	billboardGui.Parent = rootPart -- Parented directly to the part
	billboardGui.Enabled = true

	local distanceLabel = Instance.new("TextLabel")
	distanceLabel.Name = "DistanceLabel"
	distanceLabel.Size = UDim2.new(1, 0, 1, 0)
	distanceLabel.Text = "0 Studs"
	distanceLabel.TextScaled = true 
	distanceLabel.TextColor3 = Color3.new(1, 1, 1) 
	distanceLabel.TextStrokeTransparency = 0
	distanceLabel.BackgroundTransparency = 1
	distanceLabel.Font = Enum.Font.SourceSansBold
	distanceLabel.Parent = billboardGui
	
	-- Create the attachments for the beam
	local attachment0 = Instance.new("Attachment", Camera)
	local attachment1 = Instance.new("Attachment", rootPart)

	-- Create the Beam (Tracer)
	local beam = Instance.new("Beam")
	beam.Name = "RainbowBeam"
	beam.Attachment0 = attachment0
	beam.Attachment1 = attachment1
	beam.FaceCamera = true
	beam.Width0 = 0.1
	beam.Width1 = 0.1
	beam.LightEmission = 1
	beam.Parent = ESPFolder
	beam.Enabled = true 

	return {
		box = box,
		distanceLabel = distanceLabel,
		billboardGui = billboardGui, -- Added for cleanup
		beam = beam,
		rootPart = rootPart,
		humanoid = humanoid,
		attachment0 = attachment0,
		attachment1 = attachment1,
	}
end

local ESPPlayers = {}

-- Function to clean up ESP elements for a player
local function cleanupESP(player)
	if ESPPlayers[player] then
		local espData = ESPPlayers[player]
		if espData.box and espData.box.Parent then espData.box:Destroy() end
		if espData.billboardGui and espData.billboardGui.Parent then espData.billboardGui:Destroy() end -- Billboard cleanup
		if espData.beam and espData.beam.Parent then espData.beam:Destroy() end
		if espData.attachment0 and espData.attachment0.Parent then espData.attachment0:Destroy() end
		if espData.attachment1 and espData.attachment1.Parent then espData.attachment1:Destroy() end
		ESPPlayers[player] = nil
	end
end

-- Function to update ESP every frame
local function updateESP()
	local localRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not localRoot then return end

	for player, espData in pairs(ESPPlayers) do
		local character = player.Character
		local rootPart = character and character:FindFirstChild("HumanoidRootPart")
		local humanoid = character and character:FindFirstChildOfClass("Humanoid")

		if character and rootPart and humanoid and ESPEnabled then
			-- Calculate distance
			local distance = math.floor((localRoot.Position - rootPart.Position).magnitude)

			-- Get Rainbow Color
			local color = getRainbowColor()

			-- Update Box properties (RAINBOW)
			espData.box.Adornee = rootPart
			espData.box.Color3 = color 

			-- Update Distance Text (RAINBOW & VISIBLE)
			espData.distanceLabel.Text = distance .. " Studs"
			espData.distanceLabel.TextColor3 = color 
			
			-- Update Tracer (Beam)
			espData.beam.Color = ColorSequence.new(color)
		else
			-- Character no longer exists, or ESP is disabled
			cleanupESP(player)
		end
	end
end

-- Connect player character added
local function onCharacterAdded(character)
	local player = Players:GetPlayerFromCharacter(character)
	if player and player ~= LocalPlayer then
		-- Clean up any old ESP before creating new
		cleanupESP(player)

		-- Create new ESP only if enabled
		if ESPEnabled then
			local espData = createESP(player)
			if espData then
				ESPPlayers[player] = espData
			end
		end
	end
end

-- Handle players joining and leaving
Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(onCharacterAdded)
	player.CharacterRemoving:Connect(function()
		cleanupESP(player)
	end)
end)

-- Initialize ESP for players already in the game
for _, player in pairs(Players:GetPlayers()) do
	if player ~= LocalPlayer then
		player.CharacterAdded:Connect(onCharacterAdded)
		player.CharacterRemoving:Connect(function()
			cleanupESP(player)
		end)
	end
end

-- Toggle ESP function
local function toggleESP()
	ESPEnabled = not ESPEnabled
	if ESPEnabled then
		for _, player in pairs(Players:GetPlayers()) do
			if player ~= LocalPlayer and player.Character then
				cleanupESP(player)
				local espData = createESP(player)
				if espData then
					ESPPlayers[player] = espData
					-- These are now set to true in createESP, but explicitly set for existing players too.
					espData.box.Visible = true
					espData.billboardGui.Enabled = true
					espData.beam.Enabled = true
				end
			end
		end
	else
		for player, espData in pairs(ESPPlayers) do
			if espData.box then espData.box.Visible = false end
			if espData.billboardGui then espData.billboardGui.Enabled = false end -- Billboard toggle
			if espData.beam then espData.beam.Enabled = false end
		end
	end
end

-- Freecam function
local freecam = {
	enabled = false,
	speed = 1
}

local function toggleFreecam()
	freecam.enabled = not freecam.enabled

	if freecam.enabled then
		Camera.CameraType = Enum.CameraType.Scriptable
		UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
		if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
			LocalPlayer.Character.HumanoidRootPart.CanCollide = false
		end
	else
		Camera.CameraType = Enum.CameraType.Custom
		UserInputService.MouseBehavior = Enum.MouseBehavior.Default
		if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
			LocalPlayer.Character.HumanoidRootPart.CanCollide = true
		end
	end
end

local function updateFreecam()
	if not freecam.enabled then return end
	
	local moveVector = Vector3.new()
	if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveVector = moveVector + Vector3.new(0,0,1) end
	if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveVector = moveVector + Vector3.new(0,0,-1) end
	if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveVector = moveVector + Vector3.new(-1,0,0) end
	if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveVector = moveVector + Vector3.new(1,0,0) end
	if UserInputService:IsKeyDown(Enum.KeyCode.E) then moveVector = moveVector + Vector3.new(0,1,0) end
	if UserInputService:IsKeyDown(Enum.KeyCode.Q) then moveVector = moveVector + Vector3.new(0,-1,0) end

	local move = Camera.CFrame.lookVector * moveVector.Z * freecam.speed + Camera.CFrame.rightVector * moveVector.X * freecam.speed + Camera.CFrame.upVector * moveVector.Y * freecam.speed
	
	Camera.CFrame = Camera.CFrame + move
	
	local mouseDelta = UserInputService:GetMouseDelta()
	Camera.CFrame = Camera.CFrame * CFrame.Angles(0, -mouseDelta.X * 0.005, 0) * CFrame.Angles(-mouseDelta.Y * 0.005, 0, 0)
end

-- X-ray function
local function toggleXray()
	xrayEnabled = not xrayEnabled
	if xrayEnabled then
		for _, part in ipairs(workspace:GetDescendants()) do
			if part:IsA("BasePart") or part:IsA("MeshPart") or part:IsA("Part") or part:IsA("UnionOperation") then
				if part.Parent and not Players:GetPlayerFromCharacter(part.Parent) and not part:IsDescendantOf(LocalPlayer.Character) and part.Transparency < 0.9 then
					originalTransparencies[part] = part.Transparency
					part.Transparency = 0.5
				end
			end
		end
	else
		for part, transparency in pairs(originalTransparencies) do
			if part and part.Parent then
				part.Transparency = transparency
			end
		end
		originalTransparencies = {}
	end
end

-- Keybind listener
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.B then
		toggleESP()
	elseif input.KeyCode == Enum.KeyCode.C then
		toggleFreecam()
	elseif input.KeyCode == Enum.KeyCode.T then
		toggleXray()
	end
end)

-- Notify loaded (Bottom-right corner)
local function showNotification(text)
	local notificationGui = Instance.new("ScreenGui")
	notificationGui.Name = "Notification"
	notificationGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(0, 200, 0, 50)
	textLabel.Position = UDim2.new(1, -210, 1, -60)
	textLabel.Text = text
	textLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
	textLabel.Font = Enum.Font.SourceSansBold
	textLabel.FontSize = Enum.FontSize.Size24
	textLabel.BackgroundTransparency = 1
	textLabel.Parent = notificationGui

	wait(5)
	textLabel:TweenSize(UDim2.new(0, 0, 0, 0), "Out", "Quad", 1)
	wait(1)
	textLabel:Destroy()
	notificationGui:Destroy()
end

-- Full-bright prompt
local function showFullbrightPrompt()
	local promptGui = Instance.new("ScreenGui")
	promptGui.Name = "FullbrightPrompt"
	promptGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(0, 300, 0, 100)
	frame.Position = UDim2.new(0.5, -150, 0.5, -50)
	frame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
	frame.BorderSizePixel = 0
	frame.Parent = promptGui

	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(1, 0, 0, 30)
	titleLabel.Position = UDim2.new(0, 0, 0, 0)
	titleLabel.Text = "hey nephew do you want full bright on"
	titleLabel.TextColor3 = Color3.new(1, 1, 1)
	titleLabel.Font = Enum.Font.SourceSansBold
	titleLabel.FontSize = Enum.FontSize.Size18
	titleLabel.BackgroundTransparency = 1
	titleLabel.Parent = frame

	local yesButton = Instance.new("TextButton")
	yesButton.Size = UDim2.new(0.4, 0, 0.4, 0)
	yesButton.Position = UDim2.new(0.05, 0, 0.5, 0)
	yesButton.Text = "Yes"
	yesButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
	yesButton.Font = Enum.Font.SourceSansBold
	yesButton.TextColor3 = Color3.new(1, 1, 1)
	yesButton.Parent = frame

	local noButton = Instance.new("TextButton")
	noButton.Size = UDim2.new(0.4, 0, 0.4, 0)
	noButton.Position = UDim2.new(0.55, 0, 0.5, 0)
	noButton.Text = "No"
	noButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
	noButton.Font = Enum.Font.SourceSansBold
	noButton.TextColor3 = Color3.new(1, 1, 1)
	noButton.Parent = frame

	yesButton.Activated:Connect(function()
		-- Full Bright Method: Setting the color shift bottom to a bright value
		Lighting.ColorShift_Bottom = Color3.fromRGB(255, 255, 255)
		promptGui:Destroy()
	end)

	noButton.Activated:Connect(function()
		-- Reset to original value if "No" is pressed
		Lighting.ColorShift_Bottom = originalLightingColorShift
		promptGui:Destroy()
	end)
end

-- Run service update loop
RunService.RenderStepped:Connect(function()
	updateESP()
	updateFreecam()
end)

-- Startup functions
showFullbrightPrompt()
showNotification("sk8kid loaded")
